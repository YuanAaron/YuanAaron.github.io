---
layout: post 
author: oshacker
title: 深入理解MySQL索引
category: database
tags: [database,MySQL,索引]
excerpt: MySQL索引那些事
---


## 前言

当提到MySQL数据库的时候，我们的脑海中会想起几个关键字：索引、事务、数据库锁等，索引是MySQL的灵魂，是平时进行查询时的利器，也是面试的重中之重。

可能你了解索引的底层是b+树，能够加快查询，也会在表中建立索引，但这是远远不够的，这里列举几个面试常见的面试题：
1. 索引为什么要用b+树这种数据结构？
2. 聚焦索引和非聚焦索引的区别？
3. 索引什么时候会失效，最左匹配原则是什么？

当遇到这些问题的时候，可能会发现自己对索引还是一知半解，今天我们就学习MySQL的索引。

## 一条查询语句是如何执行的？

首先来看，在MySQL数据库中，一条查询语句是如何执行的，索引出现在哪个环节，起到了什么作用。

**1. 应用程序发送SQL到服务端**

当执行SQL语句时，应用程序会连接到相应的数据库服务器，然后服务器对SQL进行处理。

**2. 查询缓存**

接着数据库服务器会先去查询是否有该SQL语句的缓存（查询过的SQL会以key/value键值对的形式进行缓存，其中key是查询的语句，value是查询的结果），如果你的查询能够直接命中，就会直接从缓存中拿出value返回给客户端。

注：查询不会被解析、不会生成执行计划、不会被执行。

**3. 查询优化处理，生成执行计划**

如果没有命中缓存，则开始第三步：
+ 解析SQL：生成解析树，验证关键字（如select、where、left join等）是否正确；
+ 预处理：进一步检查解析树是否合法（如检查数据表和列是否存在，验证用户权限等）；
+ 优化SQL: 决定使用哪个索引，或者在多个表相关联的时候决定表的连接顺序。紧接着，将SQL语句转成执行计划。

**4. 将查询结果返回客户端**

最后，数据库服务器将查询结果返回给客户端。（如果查询可以缓存，MySQL也会将结果放到缓存中）

![](https://www.coderap.cn/assets/images/2020/05/query.png)

以上就是一条查询语句的执行流程，可以看到索引出现在优化SQL的步骤中，接下来了解索引到底是什么？

## 索引概述

索引是帮助数据库高效获取数据的数据结构。

### 索引的分类
+ 从存储结构上来划分
  + BTree索引（B+Tree，B-Tree）
  + 哈希索引
  + full-index全文索引
  + RTree
+ 从应用层次上来划分
  + 普通索引：一个索引只包含单个列，一个表可以有多个单列索引；
  + 唯一索引：索引列的值必须唯一，但允许有空值；
  + 复合索引：一个索引包含多个列。
+ 从表记录的排列顺序和索引的排列顺序是否一致来划分
  + 聚集索引：表记录的排列顺序和索引的排列顺序一致；
  + 非聚集索引：表记录的排列顺序和索引的排列顺序不一致。

### 聚集索引和非聚集索引

简单说，聚集索引就是以主键创建的索引；非聚集索引是以非主键创建的索引（也叫二级索引）。

**两者的区别：**
+ 聚集索引在叶子节点存储的是表中的数据
+ 非聚集索引在叶子节点存储的是主键和索引列。
+ 聚集索引的表记录的排列顺序和索引的排列顺序一致，所以查询效率快，因为只要找到第一个索引值的记录，其余连续性的记录在物理表中也会连续存放，一起就可以查询到；缺点是新增比较慢，因为为了保证表中记录的物理顺序和索引顺序一致，在记录插入的时候，会对数据页(存放记录的页)重新排序。
+ 非聚集索引的索引的逻辑顺序与磁盘上行的物理存储顺序不同，非聚集索引在叶子节点存储的是主键和索引列，当我们使用非聚集索引查询数据时，需要拿到叶子节点上的主键再去表中查询到想要查找的数据，这个过程就是我们所说的**回表**。

**举例说明：**

比如,汉语字典想要查「阿」字，只需要翻到字典前几页，a开头的位置，接着「啊」「爱」都会出来。也就是说，字典的正文部分本身就是一个目录，不需要再去查其他目录来查询想要查找的内容。我们把这种正文内容本身就是一种按照一定规则排列的目录称为聚集索引。

如果遇到不认识的字，只能根据“偏旁部首”进行查找，然后根据这个字后的页码直接翻到某页来找到要找的字，这种结合部首目录和检字表而查到的字的排序并不是真正的正文的排序方法。

![](https://www.coderap.cn/assets/images/2020/05/zidian.png)

比如,要查“玉”字，可以看到在查部首之后的检字表中“玉”的页码是587页，然后是珏，是251页。很显然，在字典中这两个字并没有挨着，现在看到的连续的“玉、珏、莹”三字实际上就是他们在非聚集索引中的排序，是字典正文中的字在非聚集索引中的映射。通过这种方式找到所需要的字要经过两个过程：先找到目录中的结果，然后再翻到结果所对应的页码。我们把这种目录纯粹是目录，正文纯粹是正文的排序方式称为非聚集索引。

### MySQL如何添加索引

1、添加PRIMARY KEY（主键索引）
```sql
ALTER TABLE `table_name` ADD PRIMARY KEY (`column`);

```

2、添加UNIQUE（唯一索引）
```sql
ALTER TABLE `table_name` ADD UNIQUE (`column`);
```

3、添加INDEX（普通索引）
```sql
ALTER TABLE `table_name` ADD INDEX index_name (`column`);
```

4、添加FULLTEXT（全文索引）
```sql
ALTER TABLE `table_name` ADD FULLTEXT (`column`);
```

5、添加多列索引
```sql
ALTER TABLE `table_name` ADD INDEX index_name (`column1`,`column2`,`column3`);
```

## 索引底层数据结构



## MySQL索引失效


参考：https://www.cnblogs.com/yixinjishu/p/12515935.html