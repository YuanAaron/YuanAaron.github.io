---
layout: post 
author: oshacker
title: 【架构入门系列】架构核心技术之分布式数据存储
category: arch
tags: [arch]
excerpt: 架构入门系列（三）
---


本篇文章主要包括以下内容：
1. MySQL复制，主从复制和主主复制两种；
2. 数据分片（数据分区），具体为数据分片的原理、分片的方案、分片数据库的扩容；
3. 数据库分布式部署的几种方案：单一部署、分库、分片；
4. NoSQL中CAP原理，分布式系统的最终一致性及其实现方案。

## MySQL数据库复制

### 主从复制

MySQL的主从复制是指将MySQL主数据库中的数据复制到从数据库中去，主要目的是实现数据库读写分离————写操作访问主数据库，读操作访问从数据库，从而使数据库具有更强大的访问负载能力，支撑更多的用户访问。

如下图，它主要的复制原理是当应用程序客户端发送一条更新命令到数据库时，数据库会把这条更新命令同步记录到Binlog中，然后由另外一个线程从Binlog中读取这条日志，再通过远程通讯的方式将它复制到从服务器上去，从服务器获得这条更新日志后，将其加入到自己的Relay log中，然后由另外一个SQL执行线程从Relay log中读取这条新的日志，并把它在本地的数据库中重新执行一遍，这样当客户端应用程序执行一个update命令时，这个命令会在主数据库和从数据库上同步执行，从而实现了主数据库向从数据库的复制，让从数据库和主数据库保持一样的数据。

![](https://www.coderap.cn/assets/images/2020/06/arch24.png)

### 一主多从复制

MySQL的主从复制是一种数据同步机制，除了可以将一个主数据库中的数据同步复制到一个从数据库上，还可以将一个主数据库上的数据同步复制到多个从数据库上，即MySQL的一主多从复制。如下图所示，多个从数据库关联到主数据库后，将主数据库上的Binlog日志同步地复制到了多个从数据库上，通过执行日志，让每个从数据库的数据都和主数据库上的数据保持一致。这里的数据更新操作表示的是所有数据库的更新操作，除了SELECT这样的的查询读操作以外，其他的INSERT、DELETE、UPDATE这样的DML写操作，以及CREATE TABLE、DROP TABLE、ALTER TABLE等DDL操作都可以同步复制到从数据库上。

![](https://www.coderap.cn/assets/images/2020/06/arch25.png)

一主多从复制有四大优点：分摊负载、专机专用、便于冷备、高可用。
1. 分摊负载：将只读操作分布在多个从数据库上，从而将负载分摊到多台服务器上。一般说来，对数据库做主从复制时，通常是为了进行读写分离，数据库的写操作会连接到主数据库上进行，而数据的读操作则连接到从服务器上进行，这样把读写两部分操作分别交给不同的服务器去处理，降低数据库的负载压力，而使用更多的从数据库向应用程序提供读服务，更好地减轻了整个数据库的访问压力。

2. 专机专用：可以针对不同类型的查询，使用不同的从服务器。比如有一台服务器专门用来做应用程序的读操作，另一个服务器专门用来执行数据报表类的操作，还有服务器可能专门执行数据备份。通过这样的方式，将不同的操作连接到不同的从数据库上，从而实现了专机专用，也进一步改善了用户的体验。

3. 便于冷备：即使数据库进行了一主多从的复制，在一些极端的情况下，比如整个机房遭遇了火灾、地震或其他一些极端灾害，甚至可能导致整个数据中心的数据服务器都丢失。代码可以再部署，但是数据库是我们过往的宝贵资源，如果历史数据都丢失了，用户信息、商品数据、订单数据...所有的数据都永久丢失了，那么即使代码都在，整个系统也永远都不可恢复了。这种损失是一个系统不能够承受的，更是一个公司不能承受的。所以很多公司都会对数据做冷备份，即把历史上的数据全部备份下来，把它存储到另外一个地方，甚至锁在保险柜里。当发生了极端灾害时，所有的数据都丢失时，还可以通过这些冷备的数据重新恢复整个网站。但是进行冷备有一个难点在于，如果数据库正在进行写操作，冷备的数据就可能不完整，数据文件可能处于损坏状态。以前的做法是停机冷备，即停止数据库的写操作，将数据文件拷贝出去后，再重新打开数据访问；现在使用一主多从的复制就可以实现零停机时间的备份，只需要关闭数据的复制进程，文件就处于关闭状态了，然后进行数据文件拷贝，拷贝完成后再重新打开数据复制就可以了。

4. 读的高可用：如果一台服务器宕机了，只要不发请求给这台服务器就不会出问题，当这台服务器恢复时，重新发请求到这台服务器。所以，在一主多从的情况下，某一台服务器宕机不可用，对整个系统的影响是非常小的。

### 主主复制

一主多从只能实现从服务器上的这些优点，当主服务器宕机不可用时，数据依然是不能够写入的，因为数据不能写入到从服务器上面去，从服务器是只读的。为了解决主服务器的可用性问题，可以使用MySQL的主主复制方案，即两台服务器都当作主服务器，任何一台服务器上收到的写操作都会复制到另一台服务器上。

下图展示了主主复制的原理。当客户端程序对主服务器A进行更新操作时，主服务器A会把更新操作写入到Binlog日志中，然后Binlog会将数据日志同步到主服务器B，写入到主服务器的Relay log中，然后执行Relay log，获得Relay log中的更新日志，执行SQL操作写入到主服务器B的本地数据库中。B服务器上的更新操作同样通过Binlog复制到服务器A的Relay log中，然后通过Relay log将数据更新到服务器A中，通过这种方式，服务器A或B任何一台服务器收到了数据的写操作，都会同步更新到另一台服务器，实现数据库的主主复制。主主复制可以提高系统的写可用，实现写操作的高可用。

![](https://www.coderap.cn/assets/images/2020/06/arch26.png)

那么，当使用MySQL服务器实现主主复制时，数据库服务器失效该如何应对？

![](https://www.coderap.cn/assets/images/2020/06/arch27.png)

如上图，正常情况下用户会写入到主服务器A中，然后数据从A复制到主服务器B上。当主服务器A失效时，写操作会被发送到主服务器B中去，数据从B服务器复制到A服务器。下面再具体看一下主主失效的维护过程，如下图。

![](https://www.coderap.cn/assets/images/2020/06/arch27.png)

最开始时，所有的主服务器都可以正常使用，当主服务器A失效时，进入故障状态，应用程序检测到主服务器A失效，检测可能需要几秒钟或者几分钟的时间，然后应用程序需要进行失效转移，将写操作发送到备份的主服务器B上去，将读操作发送到B服务器对应的从服务器上去。一段时间后故障结束，A服务器需要重建失效期间丢失的数据，也就是把自己当作从服务器从B服务器上面同步数据，同步完成后系统才能恢复正常。这个时候B服务器是用户的主要访问服务器，A服务器当作备份服务器。

### MySQL复制注意事项

使用MySQL进行复制的时候需要注意如下事项：

1. 不要对主主复制的两个数据库同时进行数据写操作，因为这种情况会导致数据冲突：两个服务器对同一条记录进行写操作，互相进行数据复制的时候，数据库就不知道哪条数据是正确的。

2. 复制只是增加了数据的读并发处理能力，并没有增加写并发能力和数据存储能力：因为数据复制后，所有的数据库存储的数据都是一样的，不管是主主复制，还是主从复制。如果存储资源不足、磁盘不够大，数据复制后，即使写到多个服务器上，存储依然是不够的。同时，它也没有增加写并发能力，即使使用主主复制，应用程序一个时间内也只能向一个数据库写入。

3. 更新数据表的结构会导致巨大的同步延迟：比如要在一张表中增加一个字段，要执行一个ALTER TABLE操作，这个操作会导致巨大的同步延迟，该操作会阻塞其它的Binlog日志同步，这时候主数据库的很多写操作都无法同步到从数据库上去，导致数据不一致。所以在实践中需要更新表结构的操作，不要写入到Binlog中，也就是关闭更新表结构的Binlog。如果要对表结构进行更新，应该由运维工程师DBA对所有的主从数据库分别进行手动数据表结构的更新操作。

## 数据分片

### 数据分片的目标

### 数据分片的特点

### 数据分片的原理与实现

### 分片数据库的伸缩扩容

## 数据库部署方案

### 单一服务和单一数据库

### 主从复制

### 业务分库

### 综合部署

## NoSQL数据库

### CAP原理与数据一致性

## 总结

